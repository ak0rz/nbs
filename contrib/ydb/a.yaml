
service: ydb_github
title: YDB sources imported from GitHub
arcanum:
  review:
    override_policy: override
    disabling_policy: denied
    min_approvers_count: 1
    disable_sticky_ships: true
    auto_assign: false
    skip_review_for: "ydb_github:@scope=development"
    groups:
    - name: devs
      # Roles must extend the list from a parent contrib folder
      roles: [ "ydb_github:@scope=development", "cc:duty", "cc:developer", "cc:consultant" ]
    rules:
    - reviewers:
        name: devs
        ship: 1

ci:
  secret: sec-01h443v2j4hk0tnywrenreh1ee
  runtime:
    sandbox-owner: YDB_GITHUB

  actions:
    import:
      title: Import YDB revision from GitHub
      flow: import-flow
      max-active: 1
      schedule:
        timezone: UTC
        cron: "0 0,6,12,18 * * *" # Four times a day, at 0:00, 6:00, 12:00, 18:00 UTC
        # Job script checks if there are non-merged PR's, and will skip import in such case
    import-b2b:
      title: Import YDB B2B to contrib/ydb - revision from GitHub branch to Arcadia branch
      flow: import-b2b-flow
      max-active: 1
      flow-vars-ui: &flow-vars-ui
        schema:
          required: [ srcBranch, trgBranch ]
          type: object
          properties:
            srcBranch:
              title: Исходная ветка в GitHub/ydb
              type: string
            trgBranch:
              title: Целевая ветка в Arcadia
              type: string
    import-b2b-legacy-ydb:
      title: Import YDB B2B to arcadia/ydb - revision from GitHub branch to Arcadia branch
      flow: import-b2b-legacy-ydb-flow
      max-active: 1
      flow-vars-ui: &flow-vars-ui
        schema:
          required: [ srcBranch, trgBranch ]
          type: object
          properties:
            srcBranch:
              title: Исходная ветка в GitHub/ydb
              type: string
            trgBranch:
              title: Целевая ветка в Arcadia
              type: string
    sync-github-canondata:
      title: Sync github ydb-platfrom/ydb canondata with S3
      flow: sync-canondata-github
      max-active: 1
      flow-vars-ui:
        schema:
          properties:
            gh_repo:
              type: string
              title: Github repo
              default: https://github.com/ydb-platform/ydb.git
            gh_branch:
              type: string
              title: Github branch
              default: main
      schedule:
        timezone: UTC
        cron: "27 * * * *"
      
      
  # Описания сборок
  flows:
    import-flow:
      title: Import YDB revision from GitHub
      jobs:
        run-script:
          title: Run import script
          task: common/misc/run_command
          requirements:
            cores: 2
            ram: 16G
            sandbox:
              client_tags: GENERIC & LINUX
              dns: dns64
          input:
            config:
              arc_mount_config:
                enabled: true
              cmd_line: |
                pwd
                ARC_SUBMIT=1 bash kikimr/scripts/oss/import_contrib/run.sh
              logs_config:
                redirect_stderr_to_stdout: true
                stdout_ci_badge: true
                add_timestamp: true

    import-b2b-flow:
      title: Import YDB B2B - revision from GitHub branch to contrib/ydb Arcadia branch

      # Задачи конкретного flow
      jobs:
        run-script:
          title: Run import script
          task: common/misc/run_command
          requirements:
            cores: 2
            ram: 16G
            sandbox:
              client_tags: GENERIC & LINUX
              dns: dns64
          input:
            config:
              arc_mount_config:
                enabled: true
              cmd_line: |
                echo Here we go
                echo "Source GitHub branch: ${flow-vars.srcBranch}"
                echo "Target Arcadia branch: ${flow-vars.trgBranch}"
                pwd
                ARC_SUBMIT=1 bash kikimr/scripts/oss/import_contrib/run_release.sh "${flow-vars.srcBranch}" "${flow-vars.trgBranch}"
              result_badges:
              - path: file1
                optional: true
              logs_config:
                redirect_stderr_to_stdout: true
                stdout_ci_badge: true
                add_timestamp: true

    import-b2b-legacy-ydb-flow:
      title: Import YDB B2B - revision from GitHub branch to arcadia/ydb Arcadia branch

      # Задачи конкретного flow
      jobs:
        run-script:
          title: Run import script
          task: common/misc/run_command
          requirements:
            cores: 2
            ram: 16G
            sandbox:
              client_tags: GENERIC & LINUX
              dns: dns64
          input:
            config:
              arc_mount_config:
                enabled: true
              cmd_line: |
                echo Here we go
                echo "Source GitHub branch: ${flow-vars.srcBranch}"
                echo "Target Arcadia branch: ${flow-vars.trgBranch}"
                pwd
                ARC_SUBMIT=1 bash kikimr/scripts/oss/import_contrib/run_ydb.sh "${flow-vars.srcBranch}" "${flow-vars.trgBranch}"
              result_badges:
              - path: file1
                optional: true
              logs_config:
                redirect_stderr_to_stdout: true
                stdout_ci_badge: true
                add_timestamp: true

    sync-canondata-github:
      title: Upload github ydb-platform/ydb canondata to S3
      jobs:
        build:
          title: build sync-canondata
          task: common/arcadia/ya_make
          input:
            targets: kikimr/scripts/oss/sync_canondata/
            test: false
            build_output_ttl: "1"
            build_output_html_ttl: "1"
            result_rd: kikimr/scripts/oss/sync_canondata/
            arts: kikimr/scripts/oss/sync_canondata/sync_canondata
            result_single_file: true
            result_ttl: "1"
            result_rt: OTHER_RESOURCE

        sync:
          needs: build
          title: upload ydb/ canondata to S3
          task: common/misc/run_command
          requirements:
            cores: 2
            ram: 16G
            sandbox:
              client_tags: GENERIC & LINUX
              dns: dns64
          input:
            config:
              cmd_line: |
                git clone --depth=1 -b "${flow-vars.gh_branch}" "${flow-vars.gh_repo}"
                {executable} --s3-bucket ydb-canondata ydb/
              sandbox_resource_placeholders:
                - key: executable
                  resource_type: OTHER_RESOURCE
              secret_environment_variables:
                - key: AWS_ACCESS_KEY_ID
                  secret_spec:
                    uuid: sec-01hek2mx17k1b6eavera0awtx3
                    key: s3_access_key
                - key: AWS_SECRET_ACCESS_KEY
                  secret_spec:
                    uuid: sec-01hek2mx17k1b6eavera0awtx3
                    key: s3_secret_key
                  
